{% extends "base.html" %}
{% block title %}Memory Reminders · Dementia Care{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h5 mb-0 text-ink-90">Memory Reminders</h1>
  <a class="btn btn-outline-ink btn-sm" href="{{ url_for('patient_home') }}">← Back to hub</a>
</div>

{# ==== derive some lists safely inside the template ==== #}
{% set all = (data.reminders or []) %}
{% set all_sorted = all|sort(attribute='dt') %}
{% set active = all|selectattr('active')|list %}
{% set faces = all|selectattr('kind','equalto','face')|list %}
{% set family = all|selectattr('kind','equalto','family')|list %}
{% set routine = all|selectattr('kind','equalto','routine')|list %}

{# next upcoming among active #}
{% set upcoming = active|sort(attribute='dt')|list %}
{% set next_item = upcoming[0] if upcoming else None %}

<!-- ===== Summary band ===== -->
<section class="card border-0 shadow-sm rounded-4 mb-3">
  <div class="card-body p-3 p-md-4">
    <div class="row g-3 align-items-center">
      <div class="col-md-5 d-flex align-items-center gap-3">
        <div class="ring" style="--pct: {{ (100 if (active|length) else 0) }};">
          <div class="ring-inner">
            <div class="ring-number">{{ active|length }}</div>
            <div class="ring-label">Active</div>
          </div>
        </div>
        <div>
          <div class="fw-semibold text-ink-90">Gentle prompts support recall</div>
          <div class="small text-ink-60">Faces, family, routines—reduce stress with timely cues.</div>
          {% if next_item %}
            <div class="small mt-1">
              <span class="badge bg-light text-ink-80">Next:</span>
              <span class="small text-ink-80 fw-semibold">{{ next_item.title }}</span>
              <span class="small text-ink-60">· {{ next_item.dt_pretty or next_item.dt }}</span>
            </div>
          {% else %}
            <div class="small mt-1 text-ink-60">No upcoming active reminders.</div>
          {% endif %}
        </div>
      </div>

      <div class="col-md-7">
        <div class="row text-center">
          <div class="col-4">
            <div class="stat-pill bg-success-subtle">
              <div class="stat-num">{{ active|length }}</div>
              <div class="stat-label">Active</div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-pill bg-light">
              <div class="stat-num">{{ all|length }}</div>
              <div class="stat-label">Total</div>
            </div>
          </div>
          <div class="col-4">
            <div class="stat-pill bg-warning-subtle">
              <div class="stat-num">{{ faces|length }}</div>
              <div class="stat-label">Familiar Faces</div>
            </div>
          </div>
        </div>
      </div>
    </div>    
  </div>
</section>

<!-- ===== Add reminder (kept) ===== -->
<section class="card border-0 shadow-sm rounded-4 mb-3">
  <div class="card-body p-3 p-md-4">
    <form class="row g-2" method="post" action="{{ url_for('patient_action') }}">
      <input type="hidden" name="action" value="add_reminder">
      <div class="col-12 col-md-4">
        <input name="rem_title" class="form-control form-control-sm" placeholder="Title (e.g., 'This is your daughter, Neha')" required>
      </div>
      <div class="col-7 col-md-4">
        <input name="rem_dt" type="datetime-local" class="form-control form-control-sm" required>
      </div>
      <div class="col-5 col-md-2">
        <select name="rem_kind" class="form-select form-select-sm">
          <option value="general" selected>General</option>
          <option value="family">Family</option>
          <option value="routine">Routine</option>
          <option value="face">Familiar Face</option>
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex align-items-center gap-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="remActive" name="rem_active" checked>
          <label class="form-check-label small" for="remActive">Active</label>
        </div>
        <button class="btn btn-cta-green btn-sm ms-auto" type="submit">Add</button>
      </div>
    </form>
  </div>
</section>

<div class="row g-3">
  <!-- ===== Main list with filters, search & sort ===== -->
  <div class="col-lg-8">
    <section class="card border-0 shadow-sm rounded-4 h-100">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
          <ul class="nav nav-pills" id="remTabs">
            <li class="nav-item"><button class="nav-link active" data-target="#remAll" type="button">All</button></li>
            <li class="nav-item"><button class="nav-link" data-target="#remActive" type="button">Active</button></li>
            <li class="nav-item"><button class="nav-link" data-target="#remFaces" type="button">Familiar Faces</button></li>
            <li class="nav-item"><button class="nav-link" data-target="#remFamily" type="button">Family</button></li>
            <li class="nav-item"><button class="nav-link" data-target="#remRoutine" type="button">Routine</button></li>
          </ul>

          <div class="d-flex gap-2">
            <input id="remSearch" class="form-control form-control-sm" placeholder="Search title…">
            <select id="remSort" class="form-select form-select-sm">
              <option value="dt_asc">Time ↑</option>
              <option value="dt_desc">Time ↓</option>
              <option value="title_asc">Title A–Z</option>
              <option value="title_desc">Title Z–A</option>
            </select>
          </div>
        </div>

        {% macro rem_table(items) -%}
        {% if items %}
        <div class="table-responsive">
          <table class="table align-middle mb-0 rem-table">
            <thead>
              <tr class="text-ink-60 small">
                <th>Title</th><th style="width:140px;">Type</th><th style="width:200px;">When</th>
                <th class="text-end" style="width:210px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in items %}
              <tr data-title="{{ r.title|lower }}" data-dt="{{ r.dt }}">
                <td class="fw-semibold text-ink-90">{{ r.title }}</td>
                <td>
                  <span class="badge
                    {% if r.kind == 'face' %} bg-indigo-soft text-ink-90
                    {% elif r.kind == 'family' %} bg-green-soft text-ink-90
                    {% elif r.kind == 'routine' %} bg-yellow-soft text-ink-90
                    {% else %} bg-light text-ink-80 {% endif %}">
                    {{ r.kind|capitalize if r.kind else 'General' }}
                  </span>
                </td>
                <td class="small text-ink-80">{{ r.dt_pretty or r.dt }}</td>
                <td class="text-end">
                  <form class="d-inline" method="post" action="{{ url_for('patient_action') }}">
                    <input type="hidden" name="action" value="toggle_reminder">
                    <input type="hidden" name="rem_id" value="{{ r.id }}">
                    <button class="btn btn-sm {% if r.active %}btn-outline-ink{% else %}btn-warning{% endif %}" type="submit">
                      {% if r.active %}Deactivate{% else %}Activate{% endif %}
                    </button>
                  </form>
                  <form class="d-inline" method="post" action="{{ url_for('patient_action') }}">
                    <input type="hidden" name="action" value="delete_reminder">
                    <input type="hidden" name="rem_id" value="{{ r.id }}">
                    <button class="btn btn-sm btn-link text-danger" type="submit" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="text-ink-60 small">No items to show.</div>
        {% endif %}
        {%- endmacro %}

        <!-- Tab panes -->
        <div id="remAll" class="tab-pane active">
          {{ rem_table(all_sorted) }}
        </div>
        <div id="remActive" class="tab-pane">
          {{ rem_table(active|sort(attribute='dt')) }}
        </div>
        <div id="remFaces" class="tab-pane">
          {{ rem_table(faces|sort(attribute='dt')) }}
        </div>
        <div id="remFamily" class="tab-pane">
          {{ rem_table(family|sort(attribute='dt')) }}
        </div>
        <div id="remRoutine" class="tab-pane">
          {{ rem_table(routine|sort(attribute='dt')) }}
        </div>

      </div>
    </section>
  </div>

  <!-- ===== Sidebar helpers ===== -->
  <div class="col-lg-4">
    <section class="card border-0 shadow-sm rounded-4 mb-3">
      <div class="card-body p-3 p-md-4">
        <div class="fw-semibold text-ink-90 mb-2">Familiar Faces</div>
        <p class="small text-ink-70 mb-2">
          Link photo boards with names/relationships to reduce confusion and build confidence.
        </p>
        <a class="btn btn-outline-ink btn-sm" href="{{ url_for('customer') }}">Open photo gallery</a>
      </div>
    </section>

    <section class="card border-0 shadow-sm rounded-4 mb-3">
      <div class="card-body p-3 p-md-4">
        <div class="fw-semibold text-ink-90 mb-2">Memory aids</div>
        <ul class="small text-ink-80 mb-0">
          <li>Keep cues consistent (same phrasing, same context).</li>
          <li>Use simple, positive language.</li>
          <li>Pair with routine (e.g., after breakfast, at 6 pm).</li>
          <li>Include a friendly face or place where helpful.</li>
        </ul>
      </div>
    </section>

    <section class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-3 p-md-4">
        <div class="fw-semibold text-ink-90 mb-2">Weekly routine ideas</div>
        <ul class="small text-ink-80 mb-0">
          <li>Monday: Call with family</li>
          <li>Wednesday: Favorite song & walk</li>
          <li>Friday: Photo album time</li>
        </ul>
      </div>
    </section>
  </div>
</div>

<!-- ===== Styles & JS ===== -->
<style>
  :root{
    --ink-90:#111827; --ink-80:#1f2937; --ink-70:#334155; --ink-60:#475569;
    --green:#16a34a; --green-2:#22c55e; --yellow:#f59e0b;
  }
  .text-ink-90{ color:var(--ink-90); } .text-ink-80{ color:var(--ink-80); }
  .text-ink-70{ color:var(--ink-70); } .text-ink-60{ color:var(--ink-60); }
  .btn-outline-ink{ color:var(--ink-80); border:1px solid rgba(0,0,0,.15); background:#fff; }
  .btn-outline-ink:hover{ color:#fff; background:#111827; border-color:#111827; }
  .btn-cta-green{ background: linear-gradient(90deg, var(--green) 0%, var(--green-2) 100%); border:0; color:#fff; }
  .rounded-4{ border-radius:1rem; }

  .bg-success-subtle{ background: rgba(16,185,129,.14)!important; }
  .bg-warning-subtle{ background: rgba(245,158,11,.20)!important; }
  .bg-indigo-soft{ background: rgba(99,102,241,.18)!important; }
  .bg-green-soft{ background: rgba(16,185,129,.18)!important; }
  .bg-yellow-soft{ background: rgba(245,158,11,.20)!important; }

  .ring{ --size:84px; --pct:0; width:var(--size); height:var(--size); border-radius:50%;
         background: conic-gradient(#16a34a calc(var(--pct) * 1%), #e5e7eb 0); display:grid; place-items:center; }
  .ring-inner{ width:calc(var(--size) - 14px); height:calc(var(--size) - 14px); border-radius:50%; background:#fff; display:grid; place-items:center; text-align:center; }
  .ring-number{ font-weight:700; line-height:1; }
  .ring-label{ font-size:.75rem; color:var(--ink-60); }

  .stat-pill{ border-radius:14px; padding:.6rem .8rem; border:1px solid rgba(0,0,0,.06); }
  .stat-num{ font-size:1.35rem; font-weight:700; line-height:1; }
  .stat-label{ font-size:.8rem; color:var(--ink-60); }

  .nav-pills .nav-link{ background:#f3f4f6; color:#111827; margin-right:.4rem; }
  .nav-pills .nav-link.active{ background:#111827; color:#fff; }
  .tab-pane{ display:none; } .tab-pane.active{ display:block; }

  .rem-table tbody tr:hover{ background:#fafafa; }
</style>

<script>
  // Tabs
  const tabs = document.querySelectorAll('#remTabs .nav-link');
  const panes = ['remAll','remActive','remFaces','remFamily','remRoutine'].map(id=>document.getElementById(id));
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tgt = btn.getAttribute('data-target');
      panes.forEach(p=>p.classList.remove('active'));
      document.querySelector(tgt).classList.add('active');
      // re-apply search/sort when switching tabs
      applySearchSort();
    });
  });

  // Search + Sort (client-side)
  const search = document.getElementById('remSearch');
  const sortSel = document.getElementById('remSort');

  function currentRows(){
    const pane = document.querySelector('.tab-pane.active');
    return pane ? pane.querySelectorAll('tbody tr') : [];
  }

  function applySearchSort(){
    const q = (search.value || '').trim().toLowerCase();
    const mode = sortSel.value;
    const rows = Array.from(currentRows());

    // filter
    rows.forEach(row=>{
      const title = row.getAttribute('data-title') || '';
      row.style.display = (!q || title.includes(q)) ? '' : 'none';
    });

    // sort
    const tbody = rows.length ? rows[0].closest('tbody') : null;
    if (!tbody) return;
    const visible = rows.filter(r=>r.style.display !== 'none');

    visible.sort((a,b)=>{
      const aT = (a.getAttribute('data-title')||'');
      const bT = (b.getAttribute('data-title')||'');
      const aD = (a.getAttribute('data-dt')||'');
      const bD = (b.getAttribute('data-dt')||'');

      switch(mode){
        case 'dt_desc': return (bD > aD) ? 1 : (bD < aD ? -1 : 0);
        case 'title_asc': return aT.localeCompare(bT);
        case 'title_desc': return bT.localeCompare(aT);
        case 'dt_asc':
        default: return (aD > bD) ? 1 : (aD < bD ? -1 : 0);
      }
    });

    visible.forEach(r=>tbody.appendChild(r));
  }

  search?.addEventListener('input', applySearchSort);
  sortSel?.addEventListener('change', applySearchSort);
  document.addEventListener('DOMContentLoaded', applySearchSort);
</script>

{% endblock %}
