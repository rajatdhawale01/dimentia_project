{% extends "base.html" %}
{% block title %}Mood Tracker ¬∑ Dementia Care{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h5 mb-0 text-ink-90">Mood Tracker</h1>
  <a class="btn btn-outline-ink btn-sm" href="{{ url_for('patient_hub') }}">‚Üê Back to hub</a>
</div>

<div class="row g-3">
  <!-- ===== TODAY ===== -->
  <div class="col-lg-6">
    <section class="card border-0 shadow-sm rounded-4 h-100">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-semibold text-ink-90">Today</div>
          <span class="badge bg-light text-ink-80">Current: {{ data.mood }}</span>
        </div>

        <form method="post" action="{{ url_for('patient_action') }}">
          <input type="hidden" name="action" value="set_mood_and_note">

          <!-- Mood options -->
          <div class="mood-grid mb-3">
            {% set MOODS = ["üòÄ Cheerful","üôÇ Calm","üòê Okay","üò¥ Tired","üôÅ Low"] %}
            {% for m in MOODS %}
            <label class="mood-pill {% if data.mood == m %}active{% endif %}">
              <input type="radio" name="mood" value="{{ m }}" {% if data.mood == m %}checked{% endif %} hidden>
              <span class="mood-emoji">{{ m.split(' ')[0] }}</span>
              <span class="mood-text">{{ m.split(' ', 1)[1] }}</span>
            </label>
            {% endfor %}
          </div>

          <!-- Quick tags -->
          <div class="small text-ink-70 mb-1">Quick tags</div>
          <div class="d-flex flex-wrap gap-2 mb-3">
            {% for tag in ["Good sleep","Walked","Ate well","Social call","Pain","Anxious","Headache"] %}
            <button class="btn btn-chip" type="button" data-insert="{{ tag }}">#{{ tag }}</button>
            {% endfor %}
          </div>

          <!-- Note -->
          <div class="mb-3">
            <textarea class="form-control" name="note" id="noteBox" rows="3" placeholder="Add an optional note‚Ä¶ (e.g., 'Walked 15 mins, ate well')"></textarea>
            <div class="d-flex justify-content-between mt-1">
              <small class="text-ink-60">Journaling helps spot patterns over time.</small>
              <button class="btn btn-link p-0 small" type="button" id="promptBtn">Need a prompt?</button>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-cta-green" type="submit">Save today‚Äôs mood</button>
            <button class="btn btn-outline-ink" type="button" id="oneMinute">1-minute reset</button>
          </div>
        </form>

        <!-- Mini breathing overlay -->
        <div id="breather" class="breather d-none">
          <div class="breather-circle" id="breathCircle"></div>
          <div class="breather-label" id="breathLabel">Breathe in‚Ä¶</div>
          <button class="btn btn-light btn-sm mt-2" type="button" id="breathStop">Stop</button>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== HISTORY ===== -->
  <div class="col-lg-6">
    <section class="card border-0 shadow-sm rounded-4 h-100">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-semibold text-ink-90">Recent history</div>
          <small class="text-ink-60">{{ data.notes|length }} total entries</small>
        </div>

        {% if data.notes %}
        <ul class="list-group list-group-flush">
          {% for n in data.notes[:8] %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="me-3">
              <div class="fw-semibold">{{ n.mood }}</div>
              {% if n.text %}<div class="small text-ink-70">{{ n.text }}</div>{% endif %}
              <div class="small text-ink-60">{{ n.ts }}</div>
            </div>
            <form method="post" action="{{ url_for('patient_action') }}">
              <input type="hidden" name="action" value="delete_note">
              <input type="hidden" name="note_id" value="{{ n.id }}">
              <button class="btn btn-sm btn-link text-danger" type="submit" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </li>
          {% endfor %}
        </ul>
        {% else %}
          <div class="text-ink-60 small">No entries yet‚Äîsave today‚Äôs mood to get started.</div>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<!-- ===== INSIGHTS ===== -->
<section class="card border-0 shadow-sm rounded-4 mt-3">
  <div class="card-body p-3 p-md-4">
    <div class="row g-3">
      <div class="col-md-5">
        <div class="fw-semibold text-ink-90 mb-2">7-day mood trend</div>
        <div id="sparkWrap">
          <svg id="sparkSvg" width="100%" height="120" viewBox="0 0 520 120" preserveAspectRatio="none">
            <line x1="0" y1="110" x2="520" y2="110" class="grid"></line>
            <polyline id="sparkLine" class="line" points=""></polyline>
            <polyline id="sparkArea" class="area" points=""></polyline>
          </svg>
          <div class="d-flex justify-content-between small text-ink-60">
            <span>6d</span><span>5d</span><span>4d</span><span>3d</span><span>2d</span><span>1d</span><span>Today</span>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="fw-semibold text-ink-90 mb-2">Mood distribution</div>
        <div class="d-flex align-items-center gap-3">
          <svg id="donut" width="120" height="120" viewBox="0 0 42 42" class="donut">
            <circle class="donut-ring" cx="21" cy="21" r="15.915"></circle>
            <!-- slices injected by JS -->
          </svg>
          <div class="small">
            <div><span class="dot dot-cheerful"></span> Cheerful</div>
            <div><span class="dot dot-calm"></span> Calm</div>
            <div><span class="dot dot-okay"></span> Okay</div>
            <div><span class="dot dot-tired"></span> Tired</div>
            <div><span class="dot dot-low"></span> Low</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="fw-semibold text-ink-90 mb-2">Gentle nudges</div>
        <ul class="small text-ink-80 mb-2">
          <li>Drink a glass of water üíß</li>
          <li>2-minute stretch or sunlight ‚òÄÔ∏è</li>
          <li>Message a loved one üíå</li>
        </ul>
        <div class="nudge-tile">
          <div class="small text-ink-70">Sleep checklist</div>
          <div class="text-ink-90 fw-semibold">Consistent bedtime?</div>
          <div class="small text-ink-60">Aim for a calm wind-down routine.</div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  :root{
    --ink-90:#111827; --ink-80:#1f2937; --ink-70:#334155; --ink-60:#475569;
    --green:#16a34a; --green-2:#22c55e; --yellow:#f59e0b;
    --c-cheer:#10b981; --c-calm:#60a5fa; --c-okay:#f59e0b; --c-tired:#a78bfa; --c-low:#ef4444;
  }
  .text-ink-90{ color:var(--ink-90); } .text-ink-80{ color:var(--ink-80); }
  .text-ink-70{ color:var(--ink-70); } .text-ink-60{ color:var(--ink-60); }
  .btn-outline-ink{ color:var(--ink-80); border:1px solid rgba(0,0,0,.15); background:#fff; }
  .btn-outline-ink:hover{ color:#fff; background:#111827; border-color:#111827; }
  .btn-cta-green{ background: linear-gradient(90deg, var(--green) 0%, var(--green-2) 100%); border:0; color:#fff; }

  .rounded-4{ border-radius:1rem; }

  .mood-grid{ display:grid; grid-template-columns: repeat(5,1fr); gap:.5rem; }
  .mood-pill{ border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:.6rem .5rem; cursor:pointer; display:flex; align-items:center; gap:.4rem; user-select:none; }
  .mood-pill:hover{ background:#f8fafc; }
  .mood-pill.active{ border-color:#16a34a; background:rgba(22,163,74,.08); }
  .mood-emoji{ font-size:1.25rem; }
  .mood-text{ font-size:.95rem; color:#111827; }

  .btn-chip{ border:1px dashed rgba(0,0,0,.18); background:#fff; color:#111827; padding:.25rem .5rem; border-radius:999px; }
  .btn-chip:hover{ background:#111827; color:#fff; }

  .breather{ position:relative; margin-top:1rem; padding:1rem; border:1px solid rgba(0,0,0,.06); border-radius:12px; text-align:center; }
  .breather-circle{ width:80px; height:80px; border-radius:50%; margin:0 auto; background:radial-gradient(circle at 50% 50%, rgba(34,197,94,.25), rgba(34,197,94,.05)); transition: transform 4s ease-in-out; }
  .breather.in .breather-circle{ transform: scale(1.15); }
  .breather.out .breather-circle{ transform: scale(0.85); }
  .breather-label{ margin-top:.5rem; color:#065f46; font-weight:600; }

  /* Sparkline */
  #sparkSvg .grid{ stroke:#e5e7eb; stroke-width:1; }
  #sparkSvg .line{ stroke:var(--green); stroke-width:2; fill:none; }
  #sparkSvg .area{ fill:rgba(34,197,94,.15); }

  /* Donut */
  .donut-ring{ fill:transparent; stroke:#e5e7eb; stroke-width:3; }
  .donut-slice{ fill:transparent; stroke-width:3; }
  .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:.3rem; }
  .dot-cheerful{ background:var(--c-cheer); }
  .dot-calm{ background:var(--c-calm); }
  .dot-okay{ background:var(--c-okay); }
  .dot-tired{ background:var(--c-tired); }
  .dot-low{ background:var(--c-low); }

  .nudge-tile{ border:1px solid rgba(0,0,0,.06); padding:.6rem .8rem; border-radius:12px; background:#f9fafb; }
</style>

<script>
  // --- Quick tag inserter
  const note = document.getElementById('noteBox');
  document.querySelectorAll('.btn-chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const t = btn.getAttribute('data-insert');
      note.value = (note.value ? note.value + ' ' : '') + '#' + t.replace(/\s+/g,'');
      note.focus();
    });
  });

  // --- Journal prompt
  const prompts = [
    "One small thing that felt good today was‚Ä¶",
    "A moment I felt calm was‚Ä¶",
    "Someone I appreciated today was‚Ä¶",
    "A song or smell that brought a memory was‚Ä¶",
    "One step I can take tomorrow is‚Ä¶"
  ];
  document.getElementById('promptBtn').addEventListener('click', ()=>{
    const p = prompts[Math.floor(Math.random()*prompts.length)];
    if(!note.value) note.value = p; else note.value += (note.value.endsWith(' ')?'':' ') + p;
    note.focus();
  });

  // --- 1-minute breathing (simple inhale/exhale loop)
  const breather = document.getElementById('breather');
  const breathCircle = document.getElementById('breathCircle');
  const breathLabel = document.getElementById('breathLabel');
  const startBtn = document.getElementById('oneMinute');
  const stopBtn = document.getElementById('breathStop');
  let breathTimer = null, phase = 'in';

  function cycle(){
    breather.classList.remove('out'); breather.classList.add('in');
    breathLabel.textContent = 'Breathe in‚Ä¶';
    setTimeout(()=>{
      breather.classList.remove('in'); breather.classList.add('out');
      breathLabel.textContent = 'Breathe out‚Ä¶';
    }, 4000);
  }
  startBtn.addEventListener('click', ()=>{
    breather.classList.remove('d-none');
    cycle();
    breathTimer = setInterval(cycle, 8000);
  });
  stopBtn.addEventListener('click', ()=>{
    if (breathTimer) clearInterval(breathTimer);
    breather.classList.add('d-none');
    breather.classList.remove('in','out');
  });

  // --- Build insights from notes (client-side only)
  const rawNotes = {{ (data.notes or [])|tojson|safe }};
  // map mood to score for sparkline
  const m2s = {"üòÄ Cheerful":5,"üôÇ Calm":4,"üòê Okay":3,"üò¥ Tired":2,"üôÅ Low":1};
  const last7 = rawNotes.slice(0,7).reverse().map(n=>m2s[n.mood]||3);
  const W=520, H=120; const baseY = 110;
  function buildSpark(arr){
    if(arr.length===0){ arr=[3,3,3,3,3,3,3]; }
    const step = (W / (arr.length-1));
    const pts = arr.map((v,i)=>{
      const y = baseY - ((v-1)/(5-1))*(baseY-20);
      const x = i*step;
      return `${x},${y}`;
    });
    document.getElementById('sparkLine').setAttribute('points', pts.join(' '));
    document.getElementById('sparkArea').setAttribute('points', `0,${baseY} ${pts.join(' ')} ${W},${baseY}`);
  }
  buildSpark(last7);

  // donut distribution
  const counts = {"üòÄ Cheerful":0,"üôÇ Calm":0,"üòê Okay":0,"üò¥ Tired":0,"üôÅ Low":0};
  rawNotes.forEach(n=>{ if(counts[n.mood]!==undefined) counts[n.mood]++; });
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  const colors = {"üòÄ Cheerful":"var(--c-cheer)","üôÇ Calm":"var(--c-calm)","üòê Okay":"var(--c-okay)","üò¥ Tired":"var(--c-tired)","üôÅ Low":"var(--c-low)"};
  const donut = document.getElementById('donut');
  let offset = 25; // start angle (quarter turn)
  Object.keys(counts).forEach(k=>{
    const pct = counts[k]/total;
    const slice = document.createElementNS('http://www.w3.org/2000/svg','circle');
    slice.setAttribute('class','donut-slice');
    slice.setAttribute('cx','21'); slice.setAttribute('cy','21'); slice.setAttribute('r','15.915');
    slice.setAttribute('stroke', colors[k]);
    slice.setAttribute('stroke-dasharray', `${(pct*100).toFixed(2)} ${100-(pct*100).toFixed(2)}`);
    slice.setAttribute('stroke-dashoffset', `${offset}`);
    donut.appendChild(slice);
    offset -= pct*100;
  });
</script>

{% endblock %}
